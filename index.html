<html>
  <head>
      <title>Webware Final Project</title>
  </head>
  <body>
    <canvas id="canvas" width="500" height="500"></canvas>
    <img id="image" src="http://www.clipartlord.com/wp-content/uploads/2015/07/rocketship19.png"/>

    <style>
      #image{
        position:absolute;
        height:20px;
        width:20px;
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
      //
      // flappy classes
      var Bird = function(x,y,velY){
        this.x = x;
        this.y = y;
        this.velY = velY;
      }
      Bird.prototype.update = function(){
          if(this.y > 500 || this.y < 250){
            return false;
          }else{
            this.y = this.y + this.velY;
            return true;
          }
      }
      Bird.prototype.flop = function(amount){
        this.velY -= amount;
      }
      Bird.prototype.fall = function(amount){
        this.velY += amount;
      }
      Bird.prototype.setAttr = function(x,y,vel){
        this.x = x;
        this.y = y;
        this.velY = vel;
      }

      var Pipe = function(x,y,height){
        this.x = x;
        this.y = y;
        this.height = height;
      }
      Pipe.prototype.update = function(){
        if(this.x < 250){
          return false;
        }else{
          this.x = this.x - 2;
          return true;
        }

      }

      //
      // asteroid classes
      var Asteroid = function(x,y,velX,velY,size){
            this.x = x;
            this.y = y;
            this.velX = velX;
            this.velY = velY;
            this.size = size;
      };
      Asteroid.prototype.updateCoord = function(xmax, xmin, ymax, ymin){
        this.x = this.x + this.velX;
        this.y = this.y + this.velY;
        if(this.x > xmax || this.x < xmin ||
           this.y > ymax || this.y < ymin){
             return false;
        }
        return true;
      }
      Asteroid.prototype.returnCoord = function(){
        return [this.x,this.y];
      }

      // array of asteroids (TODO: move inside document.ready?)
      var asteroids = [];
      // our bird and pipes
      var bird = new Bird(163, 275 , 3);
      var pipes = [];
      // how long we've been running
      var frames = 0;

      //
      // begin game
      $(document).ready(function(){
      	//Canvas stuff
      	var canvas = $("#canvas")[0];
      	var w = $("#canvas").width();
      	var h = $("#canvas").height();

        var ctx = canvas.getContext("2d");

        //snake variables
      	var cw = 10;
      	var d;
      	var food;
      	var score;
        var snakeW = w/2;
        var snakeH = h/2;
      	var snake_array; //array of cells to make up snake

        //asteroid variables
        var astPlayer = document.getElementById("image");
        astPlayer.style.left = w/4 +"px";
        astPlayer.style.top = 3*h/4 +"px";


      	function init()
      	{
          frames = 1;
          // initialize all the games
          snakeInit();
          rhythmInit();
          asteroidInit();
          flappyInit();
          // set our game loop
      		if(typeof game_loop != "undefined") clearInterval(game_loop);
      		game_loop = setInterval(paint, 80);
      	}
      	init();

      	function paint()
      	{
          // increase frames every tick
          frames++;
          // paint all of our games
      		snakePaint();
          rhythmPaint();
          asteroidPaint();
          flappyPaint();
      	}

        //
        // SNAKE
        //
        function snakeInit(){
          // direction
          d = "right";
          // set up snake and piece of food
      		create_snake();
      		create_food();
      		score = 0;
        }

        function snakePaint(){
          // paint bg every frame to erase trail
      		ctx.fillStyle = "white";
      		ctx.fillRect(0, 0, w/2, h/2);
      		ctx.strokeStyle = "black";
      		ctx.strokeRect(0, 0, w/2, h/2);
          // get position of head of snake
      		var nx = snake_array[0].x;
      		var ny = snake_array[0].y;
      		// change where next position will be based on direction
      		if(d == "right") nx++;
      		else if(d == "left") nx--;
      		else if(d == "up") ny--;
      		else if(d == "down") ny++;
          // restarts if wall hit or self hit
      		if(nx == -1 || nx == snakeW/cw || ny == -1 || ny == snakeH/cw ||
             check_collision(nx, ny, snake_array)){
      			//restart game
      			init();
      			return;
      		}
      		// if overlaps with food
      		if(nx == food.x && ny == food.y)	{
            // shift everything
      			var tail = {x: nx, y: ny};
      			score++;
      			//Create new food
      			create_food();
      		}
      		else{
            // just move him regularly
      			var tail = snake_array.pop();
      			tail.x = nx; tail.y = ny;
      		}
          //puts the tail as the first cell
      		snake_array.unshift(tail);
          // draw the snake
      		for(var i = 0; i < snake_array.length; i++){
      			var c = snake_array[i];
      			paint_cell(c.x, c.y);
      		}
      		// draw the food
      		paint_cell(food.x, food.y);
        }

        // helper to create snake at beginning
        function create_snake(){
      		var length = 5;
      		snake_array = [];
          // creates snake in array
      		for(var i = length-1; i>=0; i--){
      			snake_array.push({x: i, y:0});
      		}
      	}
      	// helper to create food at random spot in canvas
      	function create_food(){
      		food = {x: Math.round(Math.random()*(snakeW-cw)/cw),
      			      y: Math.round(Math.random()*(snakeH-cw)/cw),
      		};
      	}
        // helper to caint coordinates
        function paint_cell(x, y){
          ctx.fillStyle = "blue";
          ctx.fillRect(x*cw, y*cw, cw, cw);
          ctx.strokeStyle = "white";
          ctx.strokeRect(x*cw, y*cw, cw, cw);
        }
        // helper for checking snake collision
        function check_collision(x, y, array){
          for(var i = 0; i < array.length; i++){
            if(array[i].x == x && array[i].y == y)
             return true;
          }
          return false;
        }

        //
        // RHYTHM
        //
        var countdown = -1;
        var time = 30; // how long to count down
        function rhythmInit(){
          countdown = -1;
        }

        $(document).mousedown(function(e){
          console.log('help2:' +countdown);
          if(countdown == -1){
            init();
            return;
          }else if(countdown > 0){
            countdown = -1;
            return;
          }
        });

        function rhythmPaint(){
          //To avoid the snake trail we need to paint the BG on every frame
      		//Lets paint the canvas now
      		ctx.fillStyle = "white";
      		ctx.fillRect(w/2, 0, w/2, h/2);
      		ctx.strokeStyle = "black";
      		ctx.strokeRect(w/2, 0, w/2, h/2);

          // If time to start counting down
          if(frames % 100 == 0){
            countdown = time;
          }

          // temp var for holding to string
          var words;
          // if counting down
          if(countdown <= time && countdown > 0){
            // decrement timer and print
            countdown--;
            ctx.fillStyle = "red";
            ctx.font="140px Georgia";
            words = countdown.toString();
            ctx.fillText(words, w/2+55, h/2-100)
          }
          // Game over if the time is up
          if(countdown == 0){
            init();
            return;
          }
        }

        //
        // ASTEROIDS
        //
        // Variables for the asteroids frame
        var asteroidX_min = 0;
        var asteroidX_max = w/2;
        var asteroidY_min = h/2;
        var asteroidY_max = h;

        // Initializes the game
        function asteroidInit(){
          // Empty array of asteroids
          asteroids.forEach(function(a){
            asteroids.pop(a);
          });
          // Set location of player
          astPlayer.style.left = w/4 +"px";
          astPlayer.style.top = 3*h/4 +"px";
        }

        // Helper function to make an asteroid in "random" place
        function makeNewAsteroid(){
          var spawnLocation = Math.floor(Math.random() * 3); // random number 0 - 3
          var random_x;
          var random_y;
          var new_asteroid;
          // depending on first random num, choose where to spawn and do so
          switch(spawnLocation){
            case 0: // top
              random_x = Math.floor(Math.random() * asteroidX_max);
              new_asteroid = new Asteroid(random_x, asteroidY_min,1,1,15);
              asteroids.push(new_asteroid);
              break;
            case 1: // left
              random_y = Math.floor((Math.random() * asteroidY_max) + asteroidY_min);
              new_asteroid = new Asteroid(asteroidX_min, random_y,1,-1,15);
              asteroids.push(new_asteroid);
              break;
            case 2: // bottom
              random_x = Math.floor(Math.random() * asteroidX_max);
              new_asteroid = new Asteroid(random_x, asteroidY_max,-1,-1,15);
              asteroids.push(new_asteroid);
              break;
            case 3: // right
              random_y = Math.floor((Math.random() * asteroidY_max) + asteroidY_min);
              new_asteroid = new Asteroid(asteroidX_max, random_y,-1,-1,15);
              asteroids.push(new_asteroid);
              break;
            }
        }

        // Asteroid game loop
        function asteroidPaint(){
          // Paint bg evertime to cover trail
      		ctx.fillStyle = "white";
      		ctx.fillRect(0, h/2, w/2, h/2);
      		ctx.strokeStyle = "black";
      		ctx.strokeRect(0, h/2, w/2, h/2);

          // If mouse is moved in canvas, move player image
          $(document).mousemove(function(e){
            if((e.pageX > 0) && (e.pageX < w/2) && (e.pageY > h/2) && (e.pageY < h)){
              $("#image").css({left:e.pageX, top:e.pageY});
            }
          });
          // Make asteroids on a 20 second delay
          if(frames % 20 == 0){
            makeNewAsteroid();
          }
          // Go through and test asteroids for collison and then draw
          asteroids.forEach(function(a){
            // variables for testing collision
            var left = parseInt(astPlayer.style.left, 10);
            var top = parseInt(astPlayer.style.top, 10);
            var width = 20;
            var height = 20;
            //collision
            if(((left + width < a.x) || (a.x + a.size < left) || (top + height < a.y) || (a.y+a.size < top))){

            }
            else{ // no collison
              init();
              return;
            }

            // If asteroid is in bounds, draw it
            if(a.updateCoord(asteroidX_max, asteroidX_min, asteroidY_max, asteroidY_min)){
              ctx.fillStyle = "blue";
          		ctx.fillRect(a.x, a.y, a.size, a.size);
          		ctx.strokeStyle = "white";
          		ctx.strokeRect(a.x, a.y, a.size, a.size);
            }
          });
        }
        //
        // FLAPPY BIRD
        //

        // Switch for spawning
        var ontop = true;
        function flappyInit(){
          pipes.forEach(function(a){
            pipes.pop(a);
          });
          bird.setAttr(w/2+13, h - h/4, 3)
          // draw background, no trails
          ctx.fillStyle = "white";
          ctx.fillRect(w/2, h/2, w/2, h/2);
          ctx.strokeStyle = "black";
          ctx.strokeRect(w/2, h/2, w/2, h/2);
          bird
        }

        function makeNewPipe(){
          var height = Math.floor((Math.random() * 70) + 100);
          var new_pipe;
          if(ontop){
              ontop = false;
              new_pipe = new Pipe(w,h/2, height);
              pipes.push(new_pipe);
          }else{
              ontop = true;
              new_pipe = new Pipe(w,h-height, height);
              pipes.push(new_pipe);
          }
        }

        function paintBird(bird){
          ctx.fillStyle = "red";
      		ctx.fillRect(bird.x, bird.y, 15, 15);
      		ctx.strokeStyle = "red";
      		ctx.strokeRect(bird.x, bird.y, 15, 15);
        }

        function flappyPaint(){
          // draw background, no trails
      	   ctx.fillStyle = "white";
      		ctx.fillRect(w/2, h/2, w/2, h/2);
      		ctx.strokeStyle = "black";
      		ctx.strokeRect(w/2, h/2, w/2, h/2);

          if(frames % 100 == 0) {
            makeNewPipe();
          }

          pipes.forEach(function(p){
            //collision
            if((bird.x > p.x + 10)  ||
                (bird.x + 15 < p.x) ||
                (bird.y > p.y + p.height)  ||
                (15 + bird.y < p.y)){}
            else{
              init();
              return;
            }

            if(p.update()){
              ctx.fillStyle = "blue";
          		ctx.fillRect(p.x, p.y, 10, p.height);
          		ctx.strokeStyle = "blue";
          		ctx.strokeRect(p.x, p.y, 10, p.height);
            }
          });

          // want to paint our "bird"
          paintBird(bird);
          if(bird.update()){}
          else{
            init();
          }

          bird.fall(1);
        }

      	$(document).keydown(function(e){
      		var key = e.which;
      		if(key == "65" && d != "right") d = "left";
      		else if(key == "87" && d != "down") d = "up";
      		else if(key == "68" && d != "left") d = "right";
      		else if(key == "83" && d != "up") d = "down";
          else if((key == "32") || key == "67"){
            bird.flop(6);
          }
      	});
      });
    </script>
  </body>
</html>
